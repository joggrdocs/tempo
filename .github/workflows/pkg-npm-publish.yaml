name: 'pkgs: Publish to npm registry'
run-name: 'Publish to npm registry (${{ inputs.version }})'

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Semantic Version'
        required: true
        default: 'minor'
        type: choice
        options:
          - patch
          - minor
          - major
          - prerelease

jobs:
  publish:
    name: 'Publish to npm registry'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: 'üü™ Send Slack Notification - Start'
        uses: slackapi/slack-github-action@v2.0.0
        id: slack_start 
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_RELEASE_BOT_TOKEN }}
          payload: |
            channel: ${{ vars.SLACK_RELEASE_CHANNEL_ID }}
            text: ":package: Publish to npm: @joggr/tempo (${{ inputs.version }})"
            blocks:
              - type: header
                text:
                  type: plain_text
                  text: "@joggr/tempo (${{ inputs.version }})"
              - type: section
                text:
                  type: mrkdwn
                  text: "Starting publish to npm registry (${{ inputs.version }}) workflow."
              - type: divider
              - type: context
                elements:
                  - type: mrkdwn
                    text: '*STATUS*: Started'

      - name: 'üõí Checkout Code'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_BOT_TOKEN }}

      - name: "ùå§ Enable Corepack" 
        run: corepack enable

      - name: 'üü¢ Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: 'https://npm.pkg.github.com'
          token: ${{ secrets.GH_BOT_TOKEN }}
          scope: '@joggrdocs'
          cache: 'yarn'

      - name: 'üì¶ Install packages'
        run: yarn install

      - name: 'üîº Increment Version'
        # We have to run with npm because yarn's update is based on "stableVersion" which is not what we want
        run: yarn workspaces foreach --all exec npm version --no-git-tag-version --no-workspaces-update ${{ inputs.version }}

      - name: '#Ô∏è‚É£ Get Version'
        uses: actions/github-script@v7
        id: version
        with:
          result-encoding: string
          retries: 3
          script: |
            const fs = require('fs');
            const pj = JSON.parse(fs.readFileSync('${{ github.workspace }}/package.json'));
            return pj.version;   

      - name: 'üü™ Send Slack Notification - Building (thread)'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_RELEASE_BOT_TOKEN }}
          payload: |
            channel: ${{ vars.SLACK_RELEASE_CHANNEL_ID }}            
            thread_ts: "${{ steps.slack_start.outputs.ts }}"
            text: "Building & Publishing to npm"

      - name: 'üü™ Send Slack Notification - Building'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_RELEASE_BOT_TOKEN }}
          payload: |
            ts: ${{ steps.slack_start.outputs.ts }}
            channel: ${{ vars.SLACK_RELEASE_CHANNEL_ID }}
            text: ":package: Publish to npm: @joggr/tempo (${{ inputs.version }})"
            blocks:
              - type: header
                text:
                  type: plain_text
                  text: "@joggr/tempo (${{ inputs.version }})"
              - type: section
                text:
                  type: mrkdwn
                  text: "Starting publish to npm registry (${{ inputs.version }}) workflow."
              - type: divider
              - type: context
                elements:
                  - type: mrkdwn
                    text: '*STATUS*: üèóÔ∏è Building'

      - name: 'üèóÔ∏è Build'
        run: yarn turbo run build --filter="./packages/*"

      - name: 'üß∂ Setup .yarnrc.yml'
        run: |
          yarn config set npmScopes.joggr.npmRegistryServer "https://registry.npmjs.org"
          yarn config set npmScopes.joggr.npmAlwaysAuth true
          yarn config set npmScopes.joggr.npmAuthToken $NPM_AUTH_TOKEN
        env:
          NPM_AUTH_TOKEN: ${{ secrets.NPM_PUBLISH }}

      - name: 'üö¢ Publish'
        run: yarn workspaces foreach -A --include "packages/*" npm publish --tolerate-republish --access public

      - name: 'üíæ Commit Incremented Version'
        run: |
          git config --local user.email "${{ secrets.GH_BOT_EMAIL }}"
          git config --local user.name "${{ secrets.GH_BOT_NAME }}"
          git add ./packages/*/package.json ./package.json
          git commit -m "[ü§ñ npm-publish]: ${{ steps.version.outputs.result }} (${{ inputs.version }}) [skip-ci]"
          git push origin HEAD --force

      - name: 'üìù Publish Release Notes'
        uses: release-drafter/release-drafter@v6
        id: release_notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          version: v${{ steps.version.outputs.result }}
          publish: true

      - name: 'üü™ Send Slack Notification - Success (thread)'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_RELEASE_BOT_TOKEN }}
          payload: |
            channel: ${{ vars.SLACK_RELEASE_CHANNEL_ID }}            
            thread_ts: "${{ steps.slack_start.outputs.ts }}"
            text: "Successfully published to npm"
      
      - name: 'üü™ Send Slack Notification - Success'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_RELEASE_BOT_TOKEN }}
          payload: |
            ts: ${{ steps.slack_start.outputs.ts }}
            channel: ${{ vars.SLACK_RELEASE_CHANNEL_ID }}
            text: ":package: Publish to npm: @joggr/tempo (${{ inputs.version }})"
            blocks:
              - type: header
                text:
                  type: plain_text
                  text: "@joggr/tempo (${{ inputs.version }})"
              - type: section
                text:
                  type: mrkdwn
                  text: "Successfully published to npm registry (${{ inputs.version }}) workflow."
              - type: divider
              - type: actions
                elements:
                  - type: button
                    text: 'View Release'
                    url: ${{ steps.release_notes.outputs.html_url }}
              - type: context
                elements:
                  - type: mrkdwn
                    text: '*STATUS*: ‚úÖ Success'


      - name: 'üü™ Send Slack Notification - Failure (thread)'
        uses: slackapi/slack-github-action@v2.0.0
        if: ${{ failure() }}
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_RELEASE_BOT_TOKEN }}
          payload: |
            channel: ${{ vars.SLACK_RELEASE_CHANNEL_ID }}            
            thread_ts: "${{ steps.slack_start.outputs.ts }}"
            text: "Failed to publish to npm"
      
      - name: 'üü™ Send Slack Notification - Failure'
        uses: slackapi/slack-github-action@v2.0.0
        if: ${{ failure() }}
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_RELEASE_BOT_TOKEN }}
          payload: |
            ts: ${{ steps.slack_start.outputs.ts }}
            channel: ${{ vars.SLACK_RELEASE_CHANNEL_ID }}
            text: ":package: Publish to npm: @joggr/tempo (${{ inputs.version }})"
            blocks:
              - type: header
                text:
                  type: plain_text
                  text: "@joggr/tempo (${{ inputs.version }})"
              - type: section
                text:
                  type: mrkdwn
                  text: "Successfully published to npm registry (${{ inputs.version }}) workflow."
              - type: divider
              - type: context
                elements:
                  - type: mrkdwn
                    text: '*STATUS*: ‚ùå Failed'